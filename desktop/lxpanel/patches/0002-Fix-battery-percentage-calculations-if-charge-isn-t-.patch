From 138ff9b22b45192a3b020ebbbed04e9060470a66 Mon Sep 17 00:00:00 2001
From: Andriy Grytsenko <andrej@rep.kiev.ua>
Date: Fri, 25 Nov 2016 02:06:39 +0200
Subject: [PATCH 2/2] Fix battery percentage calculations if charge isn't
 available but energy is.

Should fix https://bugs.debian.org/845555 bug.
---
 ChangeLog               |  4 +++-
 plugins/batt/batt_sys.c | 17 ++++++++++-------
 2 files changed, 13 insertions(+), 8 deletions(-)

diff --git a/ChangeLog b/ChangeLog
index 0abe16b..f4e4f61 100644
--- a/ChangeLog
+++ b/ChangeLog
@@ -1,4 +1,6 @@
-* Fixed battery selection, it appears incompatible with 0.7.2 behavior.
+* Fixed battery selection if battery detached but another is available.
+* Fixed battery percentage calculations if charge isn't available but
+    energy is, it appears broken in 0.9.0.
 
 0.9.1
 -------------------------------------------------------------------------
diff --git a/plugins/batt/batt_sys.c b/plugins/batt/batt_sys.c
index 2482c6f..bd01e08 100644
--- a/plugins/batt/batt_sys.c
+++ b/plugins/batt/batt_sys.c
@@ -167,6 +167,7 @@ static gboolean battery_inserted(gchar* path)
 battery* battery_update(battery *b)
 {
     gchar *gctmp;
+    int promille;
 
     if (b == NULL)
         return NULL;
@@ -253,16 +254,18 @@ battery* battery_update(battery *b)
     }
 #endif
 
-    if (b->charge_full < MIN_CAPACITY)
-        b->percentage = 0;
-    else {
-        int promille = (b->charge_now * 1000) / b->charge_full;
-        b->percentage = (promille + 5) / 10; /* round properly */
-    }
+    if (b->charge_now != -1 && b->charge_full != -1)
+        promille = (b->charge_now * 1000) / b->charge_full;
+    else if (b->energy_full != -1 && b->energy_now != -1)
+        /* no charge data, let try energy instead */
+        promille = (b->energy_now * 1000) / b->energy_full;
+    else
+        promille = 0;
+
+    b->percentage = (promille + 5) / 10; /* round properly */
     if (b->percentage > 100)
         b->percentage = 100;
 
-
     if (b->current_now == -1) {
         //b->poststr = "rate information unavailable";
         b->seconds = -1;
-- 
2.11.0

